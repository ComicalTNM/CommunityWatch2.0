<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer for SR</title>
    <link rel="stylesheet" href="../GlobalStyling.css" href="https://indestructibletype.com/fonts/Jost.css">
</head>

<body>
    <nav class="topnav">
        <img src="../../components/NavBar/imgs/New_CommunityWatch_Logo.png" alt="CommunityWatch Logo" class="logo">
        <a href="../../pages/HomePage/homepage.html">Home</a>
        <a href="../../pages/SearchPage/SearchPage.html">Search</a>
        <a href="../../pages/UserPage/MyOrganizations.html">My Organizations</a>
        <a href="../../pages/ProfilePage/UserProfile.html">Profile</a>
    </nav> 
    
    <div class="form-container">
        <h1>Join in Today</h1>
        
        <br><br>
        <label for="name-entry">Name</label>
        <input type="text" id="name-entry" placeholder="Enter your name here...">
        <br><br>

        <label for="email-entry">Email</label>
        <input type="text" id="email-entry" placeholder="Enter your email here...">
        <br><br>

        <label>Providing</label>
        <div class="checklist">
            <label><input type="checkbox" id="volunteers-checkbox" value="item1" onchange="toggleVisibility('volunteers')">Volunteering</label>
            <div id="volunteers" style="display: none;">
                <label for="signup-end-date">Which Dates</label>
                <input type="date" id="Volunteer-Date">
                <br><br>
            </div>
            <br><br>
            
            <label><input type="checkbox" id="resources-checkbox" value="item2" onchange="toggleVisibility('resources')">Resources</label>
            <div id="resources" style="display: none;">
                <p>Mark how much of each resource you'll bring</p>
                <br><br>
                <label for="resource1-goal">How Many "Blank Item"</label>
                <input type="number" id="resource1-goal" placeholder="Donating...">
                <br><br>
                <label for="resource2-goal">How Many "Blank Item"</label>
                <input type="number" id="resource2-goal" placeholder="Donating...">
                <br><br>
                <label for="resource3-goal">How Many "Blank Item"</label>
                <input type="number" id="resource3-goal" placeholder="Donating...">
                <br><br>
            </div>
            <br><br>

            <label><input type="checkbox" id="donations-checkbox" value="item3" onchange="toggleVisibility('donations')">Donations</label>
            <div id="donations" style="display: none;">
                <label for="donations-goal">Please click on this link to donate!</label>
                <br><br>
                <a>Organization's Donation Link</a>
                <br><br>
            </div>
        </div>
        <br><br>

        <button class="dropbtn">Volunteer!</button>
    </div>

    <script>
        //Function to get the eventId from the URL
        function getEventIdFromUrl()
        {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('eventId');
        }

        //Function to fetch event details from server
        async function fetchEventDetails(eventId) {
            const backendURL = 'http://localhost:5000';
            try{
                const response = await fetch(`${backendURL}/api/posts/${eventId}`);
                if(!response.ok)
                {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const eventData = await response.json();
                return eventData;
            }
            catch(error){
                console.error("Error fetching event details:", error);
                alert("Failed to fetch event details.");
            }
        }

        //Function to fetch organization details from the server with the eventData
        async function fetchOrganizationDetails(eventData)
        {
            const backendURL = 'http://localhost:5000';
            try {
                if(eventData.organization)
                {
                    //ensure organizationId is a string
                    const organizationIdString = 
                        typeof eventData.organization === 'object' && eventData.organization !== null
                            ? eventData.organization._id
                            : eventData.organization;

                    //Fetch organizations data since user has an organizationId
                    const orgResponse = await fetch(`${backendURL}/api/organizations/${organizationIdString}`);
                    const organizationData = await orgResponse.json();
                    return organizationData;
                }
                else {
                    throw new Error('Could not find organization id!')
                }
            }
            catch(error) {
                console.error("Error fetching organization details:", error);
                alert("Could not find organization information!");
            }
        }

        //Function to populate the resources section
        function populateResources(itemsNeeded)
        {
            const resourcesDiv = document.getElementById('resources');
            if(itemsNeeded && itemsNeeded.length > 0){
                let resourcesHTML = '<p>Mark how much of each resource you\'ll bring</p><br><br>';
                itemsNeeded.forEach((item, index) => {
                    resourcesHTML += `
                    <label for="resource${index + 1}-goal">How Many "${item.item}"</label>
                    <input type="number" id="resource${index + 1}-goal" placeholder="Donating...">
                    <br><br>
                    `;
                });
                resourcesDiv.innerHTML = resourcesHTML;
            }
            else {
                resourcesDiv.innerHTML = '<p>No resources needed for this event.</p>';
            }
        }

        //Function to populate the donations section
        function populateDonations(organization){
            const donationsDiv = document.getElementById('donations');
            if(organization && organization.website) {
                donationsDiv.innerHTML = `
                    <label for="donations-goal">Please click on this link to donate!</label>
                    <br><br>
                    <a href="${organization.website}" target="_blank">Organization's Donation Link</a>
                    <br><br>
                `;
            }
            else {
                donationsDiv.innerHTML = `<label for="donations-goal">No donation link available.</label>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async() => {
            const eventId = getEventIdFromUrl();

            if(eventId) {
                const eventData = await fetchEventDetails(eventId);
                const organizationData = await fetchOrganizationDetails(eventData);
                if(eventData)
                {
                    populateResources(eventData.itemsNeeded);
                    populateDonations(organizationData);
                }
            }
            else {
                console.log("No event ID found in the URL.");
                alert("No event ID provided. Please return to the event page.");
            }
           
        })
        
        function toggleVisibility(id) {
            const section = document.getElementById(id);
            const checkbox = document.getElementById(id + '-checkbox');
            
            if (checkbox.checked) {
                section.style.display = 'block'; // Show the section
            } else {
                section.style.display = 'none'; // Hide the section
            }
        }
    </script>

    <footer>
        <div class="form-container">
            <p><strong>Support Team:</strong> support@example.com | +1-800-123-4567</p>
            <p>&copy; 2025 Community Watch. All rights reserved.</p>
            <div class="social-icons">
                <a href="https://www.facebook.com" target="_blank" title="Facebook">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook">
                </a>
                <a href="https://www.instagram.com" target="_blank" title="Instagram">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram">
                </a>
            </div>
        </div>
    </footer>
</body>
</html>
