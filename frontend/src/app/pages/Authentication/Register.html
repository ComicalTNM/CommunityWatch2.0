<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Page</title>

<link rel="stylesheet" href="../GlobalStyling.css" href="https://indestructibletype.com/fonts/Jost.css"   >
</head>
  
<body>
        <form id = "registrationForm"> 
            <label> First Name: </label> 
            <br  />
            <input type="text" id= "fName" name="fName" required>

            <br  />

            <label> Last Name: </label> 
            <br  />
            <input type="text" id= "lName" name="lName" required>
    
            <br/>
    
            <label> Enter Email: </label> 
            <br  />
            <input type="text" id= "email" name="email" required>
    
            <br/>
    
            <label> Enter Password: </label> 
            <br  />
            <input type="password" id="password" name="password" required>
            
            <br  />
           
            <hr  />

    
            <h3> Please Enter the Organization You Want to Register for Below </h3>
            <label>Organization Name: </label> 
            <br  />
            <!-- This will change into a drop down of Organizations we list in our system -->
            <input type="text" id="organization" name="organization" required>

            <br  />
            <br  />
    
            <button type="submit"> Register Me </button>
    
            


        </form>

        <script>
            function loginCheck() {
                var uInput = document.getElementById("email").value;
                var uRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}$/; 
                if (uRegex.test(uInput)){
                    alert("Email Valid");
                    return true;
                } 
                else{
                    alert("Email NOT valid!");
                    return false;
                }
            }
            function passCheck(){
    
                /* 
                PASSWORD
                least 1 uppercase character, 1 lowercase character, 1 number and 
                1 special character AND longer than 8 characters
                */

                var pw1 = document.getElementById("password").value;
                var pw1Regex =/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+[\]{}|;:',.<>?])[A-Za-z\d!@#$%^&*()_+[\]{}|;:',.<>?]{9,}$/;
                if(pw1Regex.test(pw1)){
                    alert("Password is good to go!");
                    return true;
                }
                else{
                    alert ("Password is NOT valid. Password must have at least 1 uppercase character, 1 lowercase character, 1 number, 1 special character AND longer than 8 characters")
                    return false;
                }
            }
            document.getElementById('registrationForm').addEventListener('submit', async function(event) {
                event.preventDefault(); //Prevents default form submission

                //Run validations and stop if either fails
                if(!loginCheck() || !passCheck())
                {
                    return; //Exit the function early if validation fails.
                }

                //Fetch CSFR token first
                const csfrResponse = await fetch('http://localhost:5000/api/auth/csrf-token', {
                    credentials: 'include' //Ensures that the cookies are received
                });

                //Read the csrf token from the cookies
                const csrfToken = document.cookie.split('; ').find(row=>row.startsWith('x-csrf-token='))?.split('=')[1]; 
                /*
                    Splits the cookies with a semicolon delimiter, then searches for the row in the cookie list that starts with 'x-csrf-token=', and if it finds that row, spilts the
                    contents of that row with a equal sign delimiter and gets the first index of the newly formed array, which should be the actual csrf token itself.
                */
               if(!csrfToken)
               {
                 alert('CSRF Token is missing!');
                 return;
               }

                //Get the data from the form
                const formData = {
                    username: document.getElementById('fName').value + ' ' + document.getElementById('lName').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    organization: document.getElementById('organization').value
                };

                try {
                    const response = await fetch('http://localhost:5000/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-csrf-token': csrfToken
                        },
                        body: JSON.stringify(formData),
                        credentials: 'include' //Ensures cookies are sent along with the request
                    });

                    const result = await response.json();
                    if(response.ok)
                    {
                        alert('Registration Successful!');
                    }
                    else
                    {
                        alert('Error: ' + result.message);
                    }
                }
                catch(error)
                {
                    console.error('Error:', error);
                    alert('Something went wrong. Please try again.');
                }            
            });
        </script>
        <footer>
            <div class="container">
                <p><strong>Support Team:</strong> support@example.com | +1-800-123-4567</p>
                <p>&copy; 2025 Community Watch. All rights reserved.</p>
                <div class="social-icons">
                    <a href="https://www.facebook.com" target="_blank" title="Facebook">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook">
                    </a>
                    <a href="https://www.instagram.com" target="_blank" title="Instagram">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram">
                    </a>
                </div>
            </div>
        </footer>
        
            </body>

</html>